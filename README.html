<!DOCTYPE html>


<!--
 | Generated by Apache Maven Doxia Site Renderer 1.11.1 from src/site/markdown/README.md.vm at 2024-08-16
 | Rendered using Apache Maven Fluido Skin 1.12.0
-->
<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content="Apache Maven Doxia Site Renderer 1.11.1" />
    <title>maven-archetypes &#x2013; Best practices Maven archetypes</title>
    <link rel="stylesheet" href="./css/apache-maven-fluido-1.12.0.min.css" />
    <link rel="stylesheet" href="./css/site.css" />
    <link rel="stylesheet" href="./css/print.css" media="print" />
    <script src="./js/apache-maven-fluido-1.12.0.min.js"></script>
    <style>.github-fork-ribbon:before { background-color: gray; }</style>
  </head>
  <body>
    <a class="github-fork-ribbon right-top" href="https://github.com/ebpro/maven-archetypes/" data-ribbon="Fork me on GitHub" title="Fork me on GitHub">Fork me on GitHub</a>
    <div class="container-fluid container-fluid-top">
      <header>
        <div id="banner">
          <div class="pull-left"><div id="bannerLeft"><h1>Apache Maven archetypes</h1>
</div>
</div>
          <div class="pull-right"></div>
          <div class="clear"><hr/></div>
        </div>

        <div id="breadcrumbs">
          <ul class="breadcrumb">
      <li><a href="https://bruno.univ-tln.fr/java" class="externalLink" title="Archetypes">Archetypes</a><span class="divider">»</span></li>
    <li class="active ">Best practices Maven archetypes <a href="https://github.com/ebpro/maven-archetypes/tree/HEAD/src/site/markdown/README.md.vm"><img src="./images/accessories-text-editor.png" title="Edit" /></a></li>
      <li id="projectVersion" class="pull-right">Version: 0.1.8</li>
          </ul>
        </div>
      </header>
      <div class="row-fluid">
        <header id="leftColumn" class="span2">
          <nav class="well sidebar-nav">
  <ul class="nav nav-list">
   <li class="nav-header">Overview</li>
    <li class="active"><a><span class="none"></span>Readme</a></li>
    <li><a href="https://spdx.org/licenses/MIT.html" class="externalLink" title="License"><span class="none"></span>License</a></li>
   <li class="nav-header">Modules</li>
    <li><a href="maven-archetype-simple/index.html" title="Maven Simple Project Archetype"><span class="none"></span>Maven Simple Project Archetype</a></li>
    <li><a href="maven-archetype-withparent/index.html" title="Maven Full Project Archetype"><span class="none"></span>Maven Full Project Archetype</a></li>
   <li class="nav-header">Project Documentation</li>
    <li><a href="project-info.html" title="Project Information"><span class="icon-chevron-right"></span>Project Information</a></li>
    <li><a href="project-reports.html" title="Project Reports"><span class="icon-chevron-right"></span>Project Reports</a></li>
  </ul>
          </nav>
          <div class="well sidebar-nav">
<form id="search-form" action="https://www.google.com/search" method="get" >
  <input value="https://ebpro.github.io/maven-archetypes/" name="sitesearch" type="hidden"/>
  <input class="search-query" name="q" id="query" type="text" placeholder="Search with Google..." />
</form>
            <div id="poweredBy">
              <div class="clear"></div>
              <div class="clear"></div>
              <div class="clear"></div>
<a href="http://maven.apache.org/" title="Built by Maven" class="poweredBy"><img class="builtBy" alt="Built by Maven" src="./images/logos/maven-feather.png" /></a>
            </div>
          </div>
        </header>
        <main id="bodyColumn"  class="span10" >
<h1>Best practices Maven archetypes</h1>
<p>This project maintains some Maven archetypes.</p>
<ul>

<li><code>fr.ebruno.maven.archetypes:simple</code> a simple standalone Java project.</li>
<li><code>fr.ebruno.maven.archetypes:simple-withparent</code>a CI ready one with a complete parent POM.</li>
</ul>
<p>An archetype to generate a simple standalone maven project.</p>
<p>To generate from the archetype :</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn archetype:generate \
    -DarchetypeGroupId=fr.ebruno.maven.archetypes \
    -DarchetypeArtifactId=maven-archetype-simple
</code></pre></div>
<p>parameters can be passed directly :</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn archetype:generate \
    -DarchetypeGroupId=fr.ebruno.maven.archetypes \
    -DarchetypeArtifactId=maven-archetype-simple \
    -DgroupId=demo.pkg \
    -DartifactId=MyApp \
    -Dversion=0.1.0-SNAPSHOT
</code></pre></div>
<p>In in the project directory, a maven wrapper should be generated to control Maven version for this project.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">cd MyApp
mvn wrapper:wrapper 
</code></pre></div>
<p>The result can be compiled with maven</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-console">cd MyApp
./mvnw verify
</code></pre></div>
<p>and executed with maven :</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-console">./mvnw exec:java -Dexec.mainClass=&quot;demo.pkg.App&quot;
</code></pre></div>
<p>but as the default <code>App</code> class is defined in a property in the ``pom.xml`, this could be simply :</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-console">./mvnw exec:java&quot;
</code></pre></div>
<p>The jar can be launch with java but the slim jar fails because of missing dependencies.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-console">java -cp target/MyApp-0.1.0-SNAPSHOT.jar demo.pkg.App
java -jar target/MyApp-0.1.0-SNAPSHOT.jar
</code></pre></div>
<p>A complete packaging (javadoc jar and shadedjar) can be done with :</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-console">./mvnw --activate-profiles javadoc,shadedjar verify
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-console">java -cp target/MyApp-0.1.0-SNAPSHOT-withdependencies.jar demo.pkg.App
java -jar target/MyApp-0.1.0-SNAPSHOT-withdependencies.jar 
</code></pre></div>
<p>Thanks to Jlink and a modular java project (jigsaw), it is possible to generate a minimal JRE with needed modules and dependencies.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">./mvnw --activate-profiles javadoc,jlink clean verify
du -hs target/image
</code></pre></div>
<p>It is interesting to compare sizes of the shaded jar, the Jlink distribution (with an embeded JRE)</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">du -hs target/*-withdependencies.jar
du -hs target/image
</code></pre></div>
<p>a web site can be generated in <code>target/site/index.html</code> with :</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-console">mvn site
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn  archetype:generate \
    -DarchetypeGroupId=fr.ebruno.maven.archetypes \
    -DarchetypeArtifactId=maven-archetype-withparent \
    -DgroupId=demo.pkg \
    -DartifactId=MyApp \
    -Dversion=0.1.0-SNAPSHOT
</code></pre></div>
<p>A parent pom is defined.
By default the jar is &#x201c;runnable&#x201d; (see <code>app.main.class</code> in <code>pom.xml</code>)</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">cd Myapp
mvn verify
java -jar target/MyApp-0.1.0-SNAPSHOT.jar
</code></pre></div>
<blockquote>

<p><b>WARNING</b>: STILL WORK IN PROGESS</p>
</blockquote>
<p>This project generates a complete Java+Maven project ready for Continuous Integration (CI).
It is ready for GitFlow, SonarQube (tests, code coverage, &#x2026;).
It can produce signed artifacts, fat jars, slim runtime with jLink, native executables with GraalVM
and container images. The build itself can also be done in a container.</p>
<p>The configuration is done with environment variables.
For GitHub : GITHUBORG (GitHub account or organisation), GITHUBACTOR, GITHUBTOKEN, GITHUBORG (org or account)
and optionally for SonarQube SONAR_URL and SONAR_TOKEN (Needs an instance of <a class="externalLink" href="https://github.com/ebpro/sonarqube">SonarQube</a>)</p>
<p>For GitHub the <a class="externalLink" href="https://cli.github.com/">CLI</a> is needed.</p>
<p>Those variables have to be stored on the CI server (see <a class="externalLink" href="https://docs.github.com/en/actions/security-guides/encrypted-secrets">GitHub Encrypted secrets</a>).
The script below transforms the local variables in GitHub secrets.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">bash -c 'for secret in GITHUBACTOR GITHUBTOKEN SONAR_URL SONAR_TOKEN; do \
eval gh secret set $secret --app actions  \
                           --body ${!secret} \
                           --org ${GITHUBORG} \
                           --visibility all; \
done'
</code></pre></div>
<blockquote>

<p><b>NOTE</b>: Short version, a wrapper script is provided (READ IT BEFORE USE).</p>
</blockquote>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">source &lt;(curl -s https://raw.githubusercontent.com/ebpro/demomavenarchetype/develop/src/main/resources/archetype-resources/ci-wrappers.sh)
new-java-project &lt;projectName&gt; &lt;groupId&gt;
</code></pre></div>
<p>Generate each new project with this maven archetype (adapt at least the bold parameters).</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn --batch-mode archetype:generate \
    -DarchetypeGroupId=fr.ebruno.maven.archetypes \
    -DarchetypeArtifactId=maven-archetype-withparent \
    -DgithubAccount=&lt;b&gt;$GITHUBORG&lt;/b&gt; \
    -DgroupId=&lt;b&gt;demo.pkg&lt;/b&gt; \
    -DartifactId=&lt;b&gt;MyApp&lt;/b&gt; \
    -Dversion=0.1.0-SNAPSHOT
</code></pre></div>
<p>To enable deployment in the repo during the CI a deployment key is needed for each repository.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">tmpKeydir=$(mktemp --directory /tmp/ci-wrappers.XXXXXX)
ssh-keygen -q -t ed25519 -C &quot;An autogenerated deploy key&quot; -N &quot;&quot; -f ${tmpKeydir}/key
gh repo deploy-key add --allow-write &quot;${tmpKeydir}/key.pub&quot;
gh secret set SECRET_DEPLOY_KEY &lt; &quot;${tmpKeydir}/key&quot;
rm -rf tmpKeydir
</code></pre></div>
<ol style="list-style-type: decimal">

<li>Initialize git environment for GitFlow (develop and master branches).</li>
<li>Make a first commit.</li>
<li>Create the GitHub repository with the <a class="externalLink" href="https://cli.github.com/">GitHub Command line Interface</a>.</li>
<li>Create an orphan gh-pages branch for the website.</li>
<li>Open the repository in a web browser.</li>
</ol>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">
git flow init -d &amp;&amp; touch README.md &amp;&amp; git add . &amp;&amp; git commit -m &quot;sets initial release.&quot; &amp;&amp; \
  gh repo create ${GITHUBORG}/${PWD##*/} --disable-wiki --private  --source=. --push &amp;&amp; \
    git checkout --orphan gh-pages &amp;&amp; \
      git rm -rf . &amp;&amp; touch index.html &amp;&amp;  \
      git add index.html &amp;&amp; \
      git commit -m &quot;sets initial empty site.&quot; &amp;&amp; \
      git push --all \
    &amp;&amp; git checkout develop &amp;&amp; \
  gh repo view --web

</code></pre></div>
<p>The project uses the <a class="externalLink" href="https://aleksandr-m.github.io/gitflow-maven-plugin">gitflow-maven-plugin</a> to manage GitFlow for java+Maven projet (branches and artifact version).</p>
<p>It is possible to easily start and finish a feature (see version in pom.xml).</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn -B gitflow:feature-start  -DpushRemote=true -DfeatureName=UI
mvn -B gitflow:feature-start  -DpushRemote=true -DfeatureName=DB

mvn -B gitflow:feature-finish  -DpushRemote=true -DfeatureName=DB
mvn -B gitflow:feature-finish  -DpushRemote=true -DfeatureName=UI 
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn -B gitflow:release-start -DpushRemote=true -DallowSnapshots=true -DuseSnapshotInRelease=true
mvn -B gitflow:release-finish -DpushRemote=true -DallowSnapshots=true
</code></pre></div>
<p>You can compile and package with unit tests.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn package
</code></pre></div>
<p>You can compile and package with unit tests and integration tests.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn verify
</code></pre></div>
<p>You can execute with maven (see app.mainClass property in pom.xml).</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn exec:java
</code></pre></div>
<p>The profile <code>shadedjar</code> generates a fat jar with all the classes from the transitive dependencies.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn -Pshadedjar clean verify
ls -lh target/*.jar
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-console">-rw-r--r--@ 1 bruno  wheel   3.1K May 20 16:09 target/MyApp-0.1.0-UI-SNAPSHOT-sources.jar
-rw-r--r--@ 1 bruno  wheel   2.6K May 20 16:09 target/MyApp-0.1.0-UI-SNAPSHOT-test-sources.jar
-rw-r--r--@ 1 bruno  wheel    38K May 20 16:09 target/MyApp-0.1.0-UI-SNAPSHOT-withdependencies.jar
-rw-r--r--@ 1 bruno  wheel   4.2K May 20 16:09 target/MyApp-0.1.0-UI-SNAPSHOT.jar
</code></pre></div>
<p>The application can then be executed without maven :</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">java -jar target/*-withdependencies.jar
</code></pre></div>
<p>Thanks to Jlink and a modular java project (jigsaw), it is possible to generate a minimal JRE with needed modules and dependencies.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn -Pjlink clean verify
du -hs target/image
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-console"> 44M    target/image
</code></pre></div>
<p>The application can then be launched without a JRE installed.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">./target/image/bin/myapp
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-console">Dec 02, 2022 11:18:56 PM fr.univtln.bruno.demos.App main
INFOS: Hello World! []
</code></pre></div>
<p>It is also possible to generate a native binary with <a class="externalLink" href="https://www.graalvm.org/">GraalVM</a>. An installation of GraalVM is needed and the package build-essential libz-dev and zlib1g-dev (zlib-devel, zlib-static et glibc-static). Only tested in linux.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">sdk install java 22.3.r19-grl
sdk use java 22.3.r19-grl
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn -Pnative clean verify
ls -lh target/testci
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-console">-rwxr-xr-x 1 bruno users 13M  3 d&#xe9;c.  00:12 target/testci
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-console">./target/testci
d&#xe9;c. 03, 2022 12:15:25 AM fr.univtln.bruno.demos.App main
INFO: Hello World! []
</code></pre></div>
<p>It is possible to build and run the project with just docker installed. A wrapper to run maven and java
in a container but to work with the current directory is proposed. ~/.m2, ~/.ssh, ~/.gitconfig and the src directories are mounted.
The environment variables needed for the project are also transmitted. The UID and GID are the one of the current user.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">docker-mvn clean -P shadedjar package
docker run --rm \
  --mount type=bind,source=&quot;$(PWD)&quot;/target/,target=/app,readonly \
  eclipse-temurin:17-jre-alpine \
    sh -c &quot;java -jar /app/*-withdependencies.jar&quot;
</code></pre></div>
<p>The file <code>docker\Dockerfile</code> is a multistage Dockerfile to build and deliver the application with several strategies (shaded jar, jlink, GraalVM) on several distributions (debian and alpine). To ease the use a wrapper for docker commands is provided in dockerw.sh</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">. ./ci-wrappers.sh
docker-wrapper-build
docker-wrapper-run
</code></pre></div>
<p>It is also possible to build all final target (Warning graalvm takes a long time to compile).</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">docker-wrapper-build-all
</code></pre></div>
<p>the result show the images and their size.</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">ebpro/testci   develop-finalShadedjarDebian   af3e072b35f7   2 hours ago   266MB
ebpro/testci   develop-finalShadedjarAlpine   38973a2aa588   2 hours ago   170MB
ebpro/testci   develop-finaljLinkDebian       db847ca5b281   2 hours ago   133MB
ebpro/testci   develop-finalJLinkAlpine       0cba42a81a33   2 hours ago   58.2MB
ebpro/testci   develop-finalGraalvmDebian     f5607a1e055f   2 hours ago   93.7MB
ebpro/testci   develop-finalGraalvmAlpine     d9c0573e4750   2 hours ago   18.8MB
</code></pre></div>
<p>It is also possible to run all the images :</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">docker-wrapper-run-all
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-log">INFO: Hello World! []
  0,06s user 0,04s system 6% cpu 1,529 total
Running ebpro/testci:develop-finalShadedjarAlpine
Dec 05, 2022 4:37:06 PM fr.univtln.bruno.demos.App main
INFO: Hello World! []
  0,05s user 0,05s system 5% cpu 1,724 total
Running ebpro/testci:develop-finaljLinkDebian
Dec 05, 2022 4:37:07 PM fr.univtln.bruno.demos.App main
INFO: Hello World! []
  0,05s user 0,05s system 5% cpu 1,690 total
Running ebpro/testci:develop-finalJLinkAlpine
Dec 05, 2022 4:37:09 PM fr.univtln.bruno.demos.App main
INFO: Hello World! []
  0,04s user 0,05s system 5% cpu 1,723 total
Running ebpro/testci:develop-finalGraalvmDebian
Dec 05, 2022 4:37:10 PM fr.univtln.bruno.demos.App main
INFO: Hello World! []
  0,05s user 0,03s system 7% cpu 1,161 total
Running ebpro/testci:develop-finalGraalvmAlpine
Dec 05, 2022 4:37:12 PM fr.univtln.bruno.demos.App main
INFO: Hello World! []
</code></pre></div>
<p>If a sonarqube server is available (i.e with <a class="externalLink" href="https://github.com/ebpro/sonarqube">https://github.com/ebpro/sonarqube</a>).
Set the variable SONAR_URL and SONAR_TOKEN</p>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn -P jacoco,sonar \
  -Dsonar.branch.name=$(git rev-parse --abbrev-ref HEAD | tr / _) \
  verify sonar:sonar 
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn clean verify
mvn -DskipTests=true \
    -Dsonar.branch.name=$(git rev-parse --abbrev-ref HEAD | tr / _) \
    -P jacoco,sonar \
    sonar:sonar
</code></pre></div>

<div class="source"><pre class="prettyprint linenums"><code class="language-bash">mvn site:site
</code></pre></div>
        </main>
      </div>
    </div>
    <hr/>
    <footer>
      <div class="container-fluid">
        <div class="row-fluid">
            <p class="pull-right">©      2020–2024
<a href="https://www.univ-tln.fr">Universit&#233; de Toulon</a>
        <li id="publishDate" class="pull-right">Last Published: 2024-08-16</li>
</p>
        </div>
      </div>
    </footer>
<script>
  if(anchors) {
    anchors.add();
  }
</script>
  </body>
</html>